<!DOCTYPE html>
<html lang="de" class="h-full">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>SQL Lernabenteuer — Version 2</title>

    <!-- Tailwind (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CodeMirror 6 (simple setup via CDN packages) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@6.0.1/theme/one-dark.css" />
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/basic-setup@0.19.1/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/lang-sql@0.19.3/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/view@0.19.45/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/state@0.19.6/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@codemirror/commands@0.19.6/dist/index.min.js"></script>

    <!-- AlaSQL for in-browser SQL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.2.2/alasql.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg:#0b1220;
            --panel:#0f1724;
        }
        html,body,#app{height:100%;}
        body{
            background:linear-gradient(180deg,#071025 0%, #071823 100%);
            color:#e6eef8;
            font-family:Inter, sans-serif;
        }
        .mono{font-family:'Fira Code', monospace;}
        /* small helpers */
        .outline-cyan{box-shadow:0 0 0 3px rgba(34,211,238,0.08);}
        /* code mirror container sizing */
        .cm-container{height:190px;}
        /* quiz option hover */
        .quiz-opt:hover{background:rgba(255,255,255,0.03);cursor:pointer}
        /* progress bar */
        .progress-bg{background:linear-gradient(90deg,#0f1724, #0b1220);}
    </style>
</head>
<body class="p-4">

<div id="app" class="max-w-7xl mx-auto flex flex-col gap-4 h-[calc(100vh-32px)]">
    <header class="flex items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl font-bold text-cyan-400">SQL Lernabenteuer</h1>
            <p class="text-sm text-gray-300">Der Fall des Daten-Diamanten — Erweitert</p>
        </div>

        <div class="flex items-center gap-3">
            <button id="reset-btn" class="bg-gray-700 hover:bg-gray-600 text-sm text-gray-100 py-2 px-3 rounded">Neu starten</button>
            <label class="flex items-center gap-2 text-sm">
                <input id="toggle-mode" type="checkbox" class="w-4 h-4"/>
                <span class="text-gray-300">Light Mode</span>
            </label>
        </div>
    </header>

    <!-- Fortschritt -->
    <div class="w-full">
        <div class="flex justify-between items-center mb-1">
            <div class="text-sm text-gray-300">Kapitel <span id="chapter-number">1</span> / <span id="chapter-total">1</span></div>
            <div class="text-sm text-gray-300" id="chapter-title-small">---</div>
        </div>
        <div class="w-full h-3 rounded progress-bg overflow-hidden">
            <div id="progress-bar" class="h-full bg-cyan-500 transition-all" style="width:0%"></div>
        </div>
    </div>

    <main class="flex gap-4 flex-1 min-h-0">
        <!-- Left: Story & Quiz -->
        <aside class="w-1/3 bg-[#071425] border border-gray-700 rounded-lg p-4 flex flex-col min-h-0">
            <div class="flex justify-between items-start gap-2">
                <h2 id="chapter-title" class="text-lg font-bold text-yellow-300"></h2>
                <div class="flex items-center gap-2">
                    <button id="hint-btn" title="Lösung & Erklärung" class="text-yellow-400 hover:text-yellow-300">
                        <!-- lightbulb -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2a7 7 0 00-4 12.9V18a1 1 0 001 1h6a1 1 0 001-1v-3.1A7 7 0 0012 2z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="story-panel" class="mt-3 overflow-auto prose prose-invert text-sm text-gray-200 flex-1 min-h-0"></div>

            <!-- Mini-Quiz Container -->
            <div id="quiz-box" class="mt-3 hidden">
                <div class="p-3 bg-gray-800/50 border border-gray-700 rounded">
                    <div id="quiz-question" class="text-sm text-gray-200 font-semibold mb-2"></div>
                    <div id="quiz-options" class="grid gap-2"></div>
                    <div id="quiz-feedback" class="mt-2 text-sm"></div>
                    <div class="flex gap-2 mt-3">
                        <button id="quiz-skip" class="py-1 px-3 rounded bg-gray-700 hover:bg-gray-600 text-sm">Überspringen</button>
                    </div>
                </div>
            </div>

            <div class="mt-3 text-xs text-gray-400">
                Tipp: Nutze <span class="mono">Ctrl/Cmd + Enter</span> zum Ausführen. Der "Tipp"-Knopf zeigt die Lösung und Erklärung.
            </div>
        </aside>

        <!-- Middle: DB & Editor -->
        <section class="flex-1 flex flex-col gap-4 min-h-0">
            <div class="bg-[#071425] border border-gray-700 rounded-lg p-4 flex gap-4 items-start">
                <div class="flex-1">
                    <h3 class="text-green-400 font-bold">Polizei-Datenbank</h3>
                    <div id="db-tabs" class="flex gap-2 mt-2"></div>
                </div>
                <div class="w-1/3">
                    <div class="text-sm text-gray-300">Schnellaktionen</div>
                    <div class="flex gap-2 mt-2">
                        <button id="btn-show-data" class="py-1 px-2 bg-cyan-600 rounded text-white text-sm">Daten anzeigen</button>
                        <button id="btn-randomize" class="py-1 px-2 bg-gray-700 rounded text-sm">Zufällige Änderung</button>
                    </div>
                </div>
            </div>

            <div class="bg-[#071425] border border-gray-700 rounded-lg p-4 min-h-0 flex flex-col">
                <div class="flex justify-between items-center gap-2 mb-2">
                    <h3 class="text-green-400 font-bold">SQL-Editor</h3>
                    <div class="flex items-center gap-2">
                        <label class="text-xs text-gray-300">Highlight: CodeMirror</label>
                    </div>
                </div>

                <div id="editor" class="cm-container rounded border border-gray-700 overflow-hidden"></div>

                <div class="flex gap-2 mt-3">
                    <button id="run-query-btn" class="flex-1 py-2 bg-cyan-600 hover:bg-cyan-500 rounded text-white font-bold">Befehl ausführen</button>
                    <button id="explain-btn" class="py-2 px-3 bg-yellow-500 hover:bg-yellow-400 rounded text-gray-900 font-bold">Erklärungen</button>
                </div>

                <div id="status-message" class="mt-2 h-6 text-sm"></div>
            </div>

            <div class="bg-[#071425] border border-gray-700 rounded-lg p-4 overflow-auto min-h-0">
                <h3 class="text-blue-400 font-bold mb-2">Daten (tabelle)</h3>
                <div id="db-content" class="text-sm"></div>
            </div>
        </section>

        <!-- Right: Result -->
        <aside class="w-1/3 bg-[#071425] border border-gray-700 rounded-lg p-4 flex flex-col min-h-0">
            <h3 class="text-blue-400 font-bold">Abfrage-Ergebnis</h3>
            <div id="result-content" class="flex-1 overflow-auto mt-2"></div>

            <div class="mt-3">
                <button id="next-chapter-btn" class="w-full py-2 bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold rounded hidden">Nächstes Kapitel</button>
            </div>
        </aside>
    </main>

    <footer class="text-xs text-gray-400 flex justify-between">
        <div>Made for Lernen — Interaktiv & Praxisnah</div>
        <div id="debug-info"></div>
    </footer>
</div>

<!-- MODALS -->
<!-- Tutorial Modal -->
<div id="tutorial-modal" class="fixed inset-0 hidden items-center justify-center z-50 bg-black/60 p-4">
    <div class="bg-[#071425] border border-yellow-500 rounded-lg p-4 max-w-2xl w-full">
        <div class="flex justify-between items-start mb-2">
            <h4 class="text-yellow-300 font-bold">Lösung & Erklärung</h4>
            <button id="close-tutorial" class="text-gray-300">Schließen</button>
        </div>
        <pre id="tutorial-command" class="mono bg-gray-900 p-3 rounded text-sm text-cyan-300 overflow-auto"></pre>
        <div id="tutorial-explanation" class="mt-3 text-sm text-gray-200"></div>
    </div>
</div>

<!-- Quiz Modal (optional bigger) -->
<div id="quiz-modal" class="fixed inset-0 hidden items-center justify-center z-60 bg-black/60 p-4">
    <div class="bg-[#071425] border border-cyan-500 rounded-lg p-4 max-w-lg w-full">
        <div id="quiz-modal-body"></div>
        <div class="flex justify-end mt-3">
            <button id="close-quiz-modal" class="py-1 px-3 bg-gray-700 rounded text-sm">Schließen</button>
        </div>
    </div>
</div>

<script>
/* ========================
   Datenbank & Kapitel-Setup
   ======================== */

alasql.options.mysql = true;

// initial dataset (base copy)
const baseDatabase = {
    Zeugen: [
        { id: 1, Name: 'Anna Schmidt', Aussage: 'Ich sah eine Person mit Hut weglaufen.' },
        { id: 2, Name: 'Peter Müller', Aussage: 'Ein rotes Auto raste davon.' },
        { id: 3, Name: 'Sabine Klein', Aussage: 'Es war gegen 22:00 Uhr.' }
    ],
    Fahrzeuge: [
        { id: 101, Halter_ID: 201, Typ: 'Limousine', Farbe: 'blau' },
        { id: 102, Halter_ID: 202, Typ: 'Kombi', Farbe: 'rot' },
        { id: 103, Halter_ID: 203, Typ: 'Sportwagen', Farbe: 'schwarz' },
        { id: 104, Halter_ID: 204, Typ: 'Kombi', Farbe: 'rot' },
    ],
    Verdaechtige: [
        { id: 201, Name: 'Max Mustermann', Alibi: 'War zu Hause.' },
        { id: 202, Name: 'Erika Mustermann', Alibi: 'War im Kino.' },
        { id: 203, Name: 'Klaus Kleber', Alibi: 'War bei Freunden.' },
        { id: 204, Name: 'Dieter Dieb', Alibi: 'Unbekannt.' },
    ]
};

// helper to deep clone base db into alasql.tables
function resetAlasqlData() {
    Object.keys(baseDatabase).forEach(t => {
        alasql.tables[t] = { data: JSON.parse(JSON.stringify(baseDatabase[t])) };
    });
}
resetAlasqlData();

/* Chapters: each chapter contains title, story (HTML), solutionCheck, tutorial, optional quiz */
const chapters = [
    {
        id: 1,
        title: "Kapitel 1: Die Grundlagen",
        story: `<p>Willkommen bei der Sondereinheit <strong>Daten</strong>, Anwärter! Dein erster Auftrag: Verschaffe dir einen Überblick über alle Zeugen.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Schreibe einen SQL-Befehl, der <strong>alle</strong> Daten aus der Tabelle <code>Zeugen</code> anzeigt.</p>`,
        solutionCheck: (res, query) => {
            return Array.isArray(res) && res.length >= 3 && res[0].Name !== undefined;
        },
        tutorial: {
            command: "SELECT * FROM Zeugen;",
            explanation: `<p><code>SELECT *</code> wählt alle Spalten. <code>FROM</code> sagt aus welcher Tabelle.</p><p>Semikolon <> beendet den Befehl (gut für Lesbarkeit).</p>`
        }
    },
    {
        id: 2,
        title: "Kapitel 2: Die Suche eingrenzen",
        story: `<p>Ein Zeuge sprach von einem roten Fluchtauto. Verwende <code>WHERE</code>, um zu filtern.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Finde alle Fahrzeuge, deren Farbe <strong>rot</strong> ist.</p>`,
        solutionCheck: (res, query) => {
            return Array.isArray(res) && res.length === 2 && res.every(r => r.Farbe === 'red' || r.Farbe === 'rot');
        },
        tutorial: {
            command: "SELECT * FROM Fahrzeuge WHERE Farbe = 'rot';",
            explanation: `<p><code>WHERE</code> filtert Zeilen. Textwerte mit einfachen Anführungszeichen.</p>`
        },
        // quiz example
        quiz: {
            question: "Welche WHERE-Anweisung findet rote Fahrzeuge?",
            options: [
                {txt:"SELECT * FROM Fahrzeuge WHERE Farbe = 'rot';", correct:true},
                {txt:"SELECT * FROM Fahrzeuge WHERE Farbe = rot;", correct:false},
                {txt:"SELECT Farbe FROM Fahrzeuge;", correct:false}
            ],
            hint: "Strings brauchen ' ' (einfaches Anführungszeichen)."
        }
    },
    {
        id: 3,
        title: "Kapitel 3: Neue Spuren",
        story: `<p>Ein neuer Zeuge 'Benno Richter' hat sich gemeldet — füge ihn ein (INSERT).</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Füge 'Benno Richter' mit seiner Aussage in die Tabelle <code>Zeugen</code> ein.</p>`,
        solutionCheck: (res, query) => {
            return alasql.tables.Zeugen.data.some(z => z.Name === 'Benno Richter');
        },
        tutorial: {
            command: "INSERT INTO Zeugen (Name, Aussage) VALUES ('Benno Richter', 'Ich habe den Täter erkannt!');",
            explanation: `<p><code>INSERT INTO</code> + <code>VALUES</code> fügt Zeilen ein. Reihenfolge der Spalten = Reihenfolge der Werte.</p>`
        }
    },
    {
        id: 4,
        title: "Kapitel 4: Fehler korrigieren (UPDATE)",
        story: `<p>Die Aussage von Anna Schmidt ist ungenau. Aktualisiere sie (UPDATE).</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Korrigiere die Aussage von 'Anna Schmidt'.</p>`,
        solutionCheck: (res, query) => {
            const a = alasql.tables.Zeugen.data.find(z => z.Name === 'Anna Schmidt');
            return a && a.Aussage && a.Aussage.includes('große');
        },
        tutorial: {
            command: "UPDATE Zeugen SET Aussage = 'Ich sah eine große Person mit Hut weglaufen.' WHERE Name = 'Anna Schmidt';",
            explanation: `<p><code>UPDATE</code> ändert vorhandene Zeilen. <strong>Ohne WHERE werden alle Zeilen geändert!</strong></p>`
        }
    },
    {
        id: 5,
        title: "Kapitel 5: JOIN — Tabellen verbinden",
        story: `<p>Kombiniere <code>Verdaechtige</code> und <code>Fahrzeuge</code>, um Eigentümer roter Autos zu finden.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Finde die Namen der Verdächtigen mit roten Autos.</p>`,
        solutionCheck: (res, query) => {
            return Array.isArray(res) && res.length >= 1 && res.some(r => r.Name && (r.Typ || r.Farbe));
        },
        tutorial: {
            command: "SELECT Verdaechtige.Name, Fahrzeuge.Typ FROM Verdaechtige JOIN Fahrzeuge ON Verdaechtige.id = Fahrzeuge.Halter_ID WHERE Fahrzeuge.Farbe = 'rot';",
            explanation: `<p><code>JOIN</code> verbindet Tabellen über eine Beziehung (ON ...).</p>`
        }
    },
    {
        id: 6,
        title: "Kapitel 6: ORDER BY — Sortieren",
        story: `<p>Sortiere Ergebnisse, damit die wichtigsten Einträge zuerst kommen.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Zeige alle Verdächtigen sortiert nach Name (A–Z).</p>`,
        solutionCheck: (res, query) => {
            // check that ORDER BY Name present
            return Array.isArray(res) && query && /ORDER\s+BY\s+NAME/i.test(query);
        },
        tutorial: {
            command: "SELECT * FROM Verdaechtige ORDER BY Name ASC;",
            explanation: `<p><code>ORDER BY</code> sortiert. <code>ASC</code> = aufsteigend, <code>DESC</code> = absteigend.</p>`
        },
        quiz: {
            question: "Wie sortierst du absteigend nach ID?",
            options: [
                {txt:"SELECT * FROM Verdaechtige ORDER BY id DESC;", correct:true},
                {txt:"SELECT * FROM Verdaechtige ORDER BY id ASC;", correct:false},
                {txt:"SELECT * FROM Verdaechtige SORT BY id DESC;", correct:false}
            ],
            hint: "Das Schlüsselwort ist ORDER BY, nicht SORT BY."
        }
    },
    {
        id: 7,
        title: "Kapitel 7: LIMIT — Ergebnisgröße begrenzen",
        story: `<p>Begrenze die Anzahl der zurückgegebenen Zeilen mit <code>LIMIT</code>.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Zeige nur die ersten 2 Fahrzeuge.</p>`,
        solutionCheck: (res, query) => Array.isArray(res) && res.length === 2,
        tutorial: {
            command: "SELECT * FROM Fahrzeuge LIMIT 2;",
            explanation: `<p><code>LIMIT</code> begrenzt die Ergebnisse.</p>`
        }
    },
    {
        id: 8,
        title: "Kapitel 8: GROUP BY & COUNT — Aggregation",
        story: `<p>Finde heraus, wie viele Fahrzeuge jede Farbe hat (GROUP BY, COUNT).</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Gruppiere Fahrzeuge nach Farbe und zähle sie.</p>`,
        solutionCheck: (res, query) => Array.isArray(res) && res.some(r => r.Farbe || r.farbe || r.cnt || r.count),
        tutorial: {
            command: "SELECT Farbe, COUNT(*) AS Anzahl FROM Fahrzeuge GROUP BY Farbe;",
            explanation: `<p><code>GROUP BY</code> fasst Zeilen zusammen. Mit Aggregatfunktionen wie <code>COUNT()</code>, <code>SUM()</code> etc. bekommst du zusammengefasste Werte.</p>`
        }
    },
    {
        id: 9,
        title: "Kapitel 9: AND / OR — Komplexe Bedingungen",
        story: `<p>Mit AND/OR kannst du mehrere Bedingungen kombinieren.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Finde Fahrzeuge, die rot und Typ 'Kombi' sind.</p>`,
        solutionCheck: (res, query) => Array.isArray(res) && query && /WHERE/i.test(query),
        tutorial: {
            command: "SELECT * FROM Fahrzeuge WHERE Farbe = 'rot' AND Typ = 'Kombi';",
            explanation: `<p><code>AND</code> erfordert beide Bedingungen; <code>OR</code> mindestens eine.</p>`
        }
    },
    {
        id: 10,
        title: "Kapitel 10: DELETE — Vorsicht beim Löschen",
        story: `<p>Manchmal muss man Daten löschen. <strong>Achtung:</strong> DELETE entfernt Daten dauerhaft.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Lösche testweise den Zeugen mit Namen 'Dieter Dieb' (nur zum Üben).</p>`,
        solutionCheck: (res, query) => !alasql.tables.Zeugen.data.some(z => z.Name === 'Dieter Dieb'),
        tutorial: {
            command: "DELETE FROM Zeugen WHERE Name = 'Dieter Dieb';",
            explanation: `<p><strong>Niemals</strong> löschen ohne WHERE. Testdaten kannst du löschen, aber in echten DBs vorher Backup!</p>`
        }
    },
    {
        id: 11,
        title: "Rückblick: Gemischte Aufgaben",
        story: `<p>Jetzt mischen wir das Gelernte. Erwartet werden verschiedene kurze Aufgaben — probiere SELECT, WHERE, JOIN oder GROUP BY.</p>
                <p class="mt-3 text-yellow-300"><strong>Aufgabe:</strong> Löse die zufällige Übung, die dir gestellt wird.</p>`,
        isReview: true,
        tutorial: {
            command: "-- Beispiel (nur beispielhaft):\\nSELECT Verdaechtige.Name, COUNT(*) FROM Verdaechtige JOIN Fahrzeuge ON Verdaechtige.id = Fahrzeuge.Halter_ID GROUP BY Verdaechtige.Name;",
            explanation: `<p>Im Review werden mehrere Konzepte kombiniert.</p>`
        }
    },
    {
        id: 12,
        title: "Fall gelöst!",
        story: `<p class="text-yellow-300 font-bold text-lg">HERZLICHEN GLÜCKWUNSCH — Fall gelöst!</p>
                <p>Du hast die Grundlagen von SQL gelernt. Wiederhole Kapitel oder probiere eigene Queries.</p>`,
        isEnd: true
    }
];

let currentChapterIndex = 0;
const chapterTotal = chapters.length;
document.getElementById('chapter-total').textContent = chapterTotal;

/* ========================
   Renderer & UI Helpers
   ======================== */

const el = id => document.getElementById(id);

function setStatus(msg, kind='') {
    const el = document.getElementById('status-message');
    el.innerHTML = msg;
    if(kind==='ok') el.classList.add('text-green-400'); else el.classList.remove('text-green-400');
}

/* Render DB tabs */
let activeTable = Object.keys(baseDatabase)[0];

function renderDbTabs() {
    const container = el('db-tabs');
    container.innerHTML = '';
    Object.keys(alasql.tables).forEach(t => {
        const btn = document.createElement('button');
        btn.className = `py-1 px-3 text-sm rounded ${t===activeTable?'bg-gray-700 text-green-300':'text-gray-300 hover:bg-gray-700/50'}`;
        btn.textContent = t;
        btn.onclick = () => { activeTable = t; renderDbContent(); renderTabsActive(); };
        container.appendChild(btn);
    });
}

function renderTabsActive(){ /* just refresh visuals */ renderDbTabs(); }

function renderDbContent() {
    const data = alasql.tables[activeTable].data;
    const container = el('db-content');
    container.innerHTML = '';
    if(!data || data.length===0) {
        container.innerHTML = `<div class="text-sm text-gray-400 italic">Keine Daten.</div>`;
        return;
    }
    // build table
    const headers = Object.keys(data[0]);
    const tbl = document.createElement('table');
    tbl.className = 'w-full text-sm border-collapse';
    const thead = document.createElement('thead');
    thead.innerHTML = '<tr>' + headers.map(h=>`<th class="p-2 text-left text-xs font-semibold text-gray-300 border-b border-gray-700">${h}</th>`).join('') + '</tr>';
    tbl.appendChild(thead);
    const tbody = document.createElement('tbody');
    data.forEach(row => {
        const r = document.createElement('tr');
        r.className = 'hover:bg-gray-700/20';
        r.innerHTML = headers.map(h=>`<td class="p-2 font-mono text-xs border-b border-gray-800 text-gray-200">${row[h] ?? ''}</td>`).join('');
        tbody.appendChild(r);
    });
    tbl.appendChild(tbody);
    container.appendChild(tbl);
}

/* render result table for SELECT results */
function renderResult(res) {
    const container = el('result-content');
    container.innerHTML = '';
    if(!res) { container.innerHTML = '<div class="text-gray-400 italic">Keine Ausgabe.</div>'; return; }
    if(Array.isArray(res) && res.length>0 && typeof res[0] === 'object') {
        // table mode
        const headers = Object.keys(res[0]);
        const tbl = document.createElement('table');
        tbl.className = 'w-full text-sm border-collapse';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr>' + headers.map(h=>`<th class="p-2 text-left text-xs font-semibold text-gray-300 border-b border-gray-700">${h}</th>`).join('') + '</tr>';
        tbl.appendChild(thead);
        const tbody = document.createElement('tbody');
        res.forEach(row => {
            const r = document.createElement('tr');
            r.className = 'hover:bg-gray-700/20';
            r.innerHTML = headers.map(h=>`<td class="p-2 font-mono text-xs border-b border-gray-800 text-gray-200">${row[h] ?? ''}</td>`).join('');
            tbody.appendChild(r);
        });
        tbl.appendChild(tbody);
        container.appendChild(tbl);
    } else {
        // raw output
        const pre = document.createElement('pre');
        pre.className = 'mono text-sm text-gray-200';
        pre.textContent = JSON.stringify(res, null, 2);
        container.appendChild(pre);
    }
}

/* ========================
   CodeMirror Editor Setup
   ======================== */

let editorView;
(async function initEditor(){
    const {EditorView, basicSetup} = window["@codemirror/basic-setup"];
    const {sql} = window["@codemirror/lang-sql"];
    const {EditorState} = window["@codemirror/state"];
    const {defaultKeymap} = window["@codemirror/commands"];

    const startDoc = "-- Schreibe deinen SQL-Befehl hier...\nSELECT * FROM Zeugen;";

    editorView = new EditorView({
        state: EditorState.create({
            doc: startDoc,
            extensions: [
                basicSetup,
                sql(),
                EditorView.theme({
                    '&': {backgroundColor: '#0b1220', color: '#e6eef8'},
                    '.cm-content': {fontFamily: 'Fira Code, monospace', fontSize: '13px'},
                }),
                EditorView.updateListener.of(u => {
                    // detect Ctrl/Cmd+Enter manually? We'll use keymap later
                })
            ]
        }),
        parent: document.getElementById('editor')
    });

    // handle Ctrl/Cmd + Enter
    document.addEventListener('keydown', (e)=> {
        if((e.ctrlKey||e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            runCurrentQuery();
        }
    });
})();

/* ========================
   Chapter Flow
   ======================== */

function renderChapter(index) {
    if(index < 0) index = 0;
    if(index >= chapters.length) index = chapters.length-1;
    currentChapterIndex = index;
    const c = chapters[index];

    el('chapter-number').textContent = index+1;
    el('chapter-title').textContent = c.title;
    el('chapter-title-small').textContent = c.title;
    el('story-panel').innerHTML = c.story;

    // progress bar
    const pct = Math.round(((index) / (chapters.length-1)) * 100);
    el('progress-bar').style.width = pct + '%';

    // placeholder in editor
    if(editorView) {
        // clear selection, set sample if provided
        const sample = c.tutorial?.command ?? "";
        editorView.dispatch({
            changes: {from: 0, to: editorView.state.doc.length, insert: sample}
        });
    }
    // UI: quiz show/hide
    if(c.quiz) showQuizInline(c.quiz); else hideQuizInline();

    // show/hide next chapter button
    el('next-chapter-btn').classList.add('hidden');

    // update DB view
    renderDbTabs();
    renderDbContent();

    // update hint modal content if available
    // (handled in hint button event)
}

/* ========================
   Quiz: inline & modal
   ======================== */

function showQuizInline(quiz) {
    el('quiz-box').classList.remove('hidden');
    el('quiz-question').innerHTML = quiz.question;
    const opts = el('quiz-options');
    opts.innerHTML = '';
    quiz.options.forEach((o,i) => {
        const div = document.createElement('div');
        div.className = 'quiz-opt p-2 rounded text-sm text-gray-200 quiz-option';
        div.textContent = o.txt;
        div.onclick = () => {
            if(o.correct) {
                el('quiz-feedback').innerHTML = `<span class="text-green-400 font-bold">Richtig!</span>`;
            } else {
                el('quiz-feedback').innerHTML = `<span class="text-red-400">Falsch — Tipp: ${quiz.hint || 'Überprüfe die Syntax.'}</span>`;
            }
        };
        opts.appendChild(div);
    });
    el('quiz-feedback').innerHTML = '';
}

function hideQuizInline() {
    el('quiz-box').classList.add('hidden');
}

/* ========================
   Run & Validation
   ======================== */

function runCurrentQuery() {
    setStatus('', '');
    const query = editorView ? editorView.state.doc.toString().trim() : '';
    if(!query) return;
    try {
        const res = alasql(query);

        // show results
        if(query.trim().toUpperCase().startsWith('SELECT')) {
            renderResult(res);
        } else {
            // mutation - re-render DB
            renderResult(["Befehl ausgeführt."]);
            renderDbContent();
        }

        // check solution for chapter
        const chapter = chapters[currentChapterIndex];
        let solved = false;
        try {
            if(chapter.solutionCheck) solved = chapter.solutionCheck(res, query);
            // if review, do some random checks
            if(chapter.isReview) solved = true; // accept any successful query for review
        } catch(e) {
            solved = false;
            console.error(e);
        }

        if(solved) {
            setStatus('Erfolg! Das Kapitel ist bestanden. Du kannst zum nächsten Kapitel.', 'ok');
            el('next-chapter-btn').classList.remove('hidden');
        } else {
            setStatus('Das Ergebnis ist nicht ganz richtig. Probiere einen Tipp oder versuche es erneut.');
        }

    } catch (err) {
        setStatus(`Fehler: ${err.message}`);
        el('result-content').innerHTML = `<pre class="mono text-sm text-red-400">${err.message}</pre>`;
    }
}

/* ========================
   Events & Buttons
   ======================== */

el('run-query-btn').addEventListener('click', runCurrentQuery);
el('next-chapter-btn').addEventListener('click', ()=> {
    if(currentChapterIndex < chapters.length-1) {
        currentChapterIndex++;
        renderChapter(currentChapterIndex);
    }
});
el('hint-btn').addEventListener('click', ()=> {
    const c = chapters[currentChapterIndex];
    if(!c || !c.tutorial) return;
    el('tutorial-command').textContent = c.tutorial.command || '';
    el('tutorial-explanation').innerHTML = c.tutorial.explanation || '';
    el('tutorial-modal').classList.remove('hidden');
});
el('close-tutorial').addEventListener('click', ()=> el('tutorial-modal').classList.add('hidden'));

el('reset-btn').addEventListener('click', ()=> {
    if(confirm('Datenbank zurücksetzen und von vorne beginnen?')) {
        resetAlasqlData();
        renderDbTabs();
        renderDbContent();
        renderChapter(0);
        setStatus('Neu gestartet.');
    }
});

el('btn-show-data').addEventListener('click', ()=> {
    renderDbContent();
    setStatus('Daten angezeigt.');
});
el('btn-randomize').addEventListener('click', ()=> {
    // tiny random mutation for practice
    const v = alasql.tables.Fahrzeuge.data;
    if(v && v.length>0) {
        const i = Math.floor(Math.random()*v.length);
        v[i].Farbe = v[i].Farbe === 'rot' ? 'blau' : 'rot';
        renderDbContent();
        setStatus('Zufällige Änderung vorgenommen.');
    }
});

/* Keyboard: also allow Enter in editor? handled via Ctrl+Enter earlier. */

/* ========================
   Dark/Light Toggle
   ======================== */

el('toggle-mode').addEventListener('change', (e)=>{
    const checked = e.target.checked;
    if(checked) {
        document.documentElement.style.background = '#f8fafc';
        document.body.style.color = '#0b1220';
        // small visual flip: (not comprehensive)
        document.querySelectorAll('.bg-[#071425]').forEach(n=>n.style.backgroundColor='#ffffff');
    } else {
        document.documentElement.style.background = '';
        document.body.style.color = '';
        document.querySelectorAll('.bg-[#071425]').forEach(n=>n.style.backgroundColor='');
    }
});

/* ========================
   Init & utilities
   ======================== */

function init() {
    renderChapter(currentChapterIndex);
    renderDbTabs();
    renderDbContent();
    el('chapter-total').textContent = chapters.length;
    // set debug
    el('debug-info').textContent = `Kapitel ${currentChapterIndex+1}/${chapters.length}`;
}

init();

/* Optional: adjust solution checks that expect 'rot' to account for english 'red' if used */
function normalizeFarbeValue() {
    // convert any 'red' occurrences to 'rot' for consistent checks
    alasql.tables.Fahrzeuge.data.forEach(f=>{
        if(f.Farbe && f.Farbe.toLowerCase() === 'red') f.Farbe = 'rot';
    });
}
normalizeFarbeValue();

/* Tiny safety: autosave DB to localStorage (so progress persists) */
(function autosave() {
    const key = 'lern-sql-db-v2';
    // load if exists
    try {
        const saved = localStorage.getItem(key);
        if(saved) {
            const parsed = JSON.parse(saved);
            if(parsed && typeof parsed === 'object') {
                Object.keys(parsed).forEach(t => { if(alasql.tables[t]) alasql.tables[t].data = parsed[t]; });
            }
        }
    } catch(e){}
    // save on unload
    window.addEventListener('beforeunload', ()=>{
        try {
            const out = {};
            Object.keys(alasql.tables).forEach(t => out[t] = alasql.tables[t].data);
            localStorage.setItem(key, JSON.stringify(out));
        } catch(e){}
    });
})();

</script>
</body>
</html>
