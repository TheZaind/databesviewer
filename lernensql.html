<!DOCTYPE html>
<html lang="de" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Lernabenteuer: Der Fall des Daten-Diamanten</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/4.2.2/alasql.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Fira+Code:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .font-mono {
            font-family: 'Fira Code', monospace;
        }
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
        /* Typing cursor effect */
        .typing-cursor::after {
            content: '▋';
            animation: blink 1s step-end infinite;
        }
        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>
<body class="h-full text-gray-200 p-2 sm:p-4">

    <div id="app" class="flex flex-col h-full max-w-7xl mx-auto">
        <header class="border-b-2 border-cyan-500/30 pb-2 mb-4">
            <h1 class="text-2xl sm:text-3xl font-bold text-cyan-400">SQL Lernabenteuer</h1>
            <p class="text-sm sm:text-base text-gray-400">Der Fall des Daten-Diamanten</p>
        </header>

        <main class="flex-grow flex flex-col lg:flex-row gap-4 min-h-0">

            <!-- Linke Spalte: Story & Anweisungen -->
            <section id="story-panel" class="lg:w-1/3 flex flex-col bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                <h2 id="chapter-title" class="text-xl font-bold text-yellow-400 mb-2"></h2>
                <div class="flex-grow overflow-y-auto pr-2">
                    <div id="story-content" class="prose prose-invert text-gray-300"></div>
                </div>
            </section>

            <!-- Mittlere Spalte: Datenbank & Editor -->
            <section id="interactive-panel" class="lg:w-1/3 flex flex-col gap-4">
                <div class="flex flex-col bg-gray-800/50 border border-gray-700 rounded-lg p-4 min-h-0">
                    <h2 class="text-xl font-bold text-green-400 mb-2">Polizei-Datenbank</h2>
                    <div id="db-tabs" class="flex border-b border-gray-600 mb-2"></div>
                    <div id="db-content" class="flex-grow overflow-auto text-sm"></div>
                </div>
                <div class="flex flex-col bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-xl font-bold text-green-400">SQL-Editor</h2>
                        <!-- NEU: Tutorial-Button (Glühbirne) -->
                        <button id="hint-btn" title="Hilfe anzeigen" class="text-yellow-400 hover:text-yellow-300 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M11 3a1 1 0 100 2h.01a1 1 0 100-2H11zM10 1a1 1 0 00-1 1v1a1 1 0 002 0V2a1 1 0 00-1-1zM10 15a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1zM4.343 5.757a1 1 0 00-1.414-1.414L2.5 4.779a1 1 0 101.414 1.414l.43- .43zM15.657 5.757a1 1 0 001.414-1.414l-1.414-1.414a1 1 0 00-1.414 1.414l1.414 1.414zM1.5 10a1 1 0 011-1h1.01a1 1 0 110 2H2.5a1 1 0 01-1-1zM17.5 10a1 1 0 011-1h1.01a1 1 0 110 2H18.5a1 1 0 01-1-1zM5.757 15.657a1 1 0 00-1.414 1.414l.43.43a1 1 0 001.414-1.414l-.43-.43zM14.243 15.657a1 1 0 00-1.414 1.414l1.414 1.414a1 1 0 001.414-1.414l-1.414-1.414z" />
                                <path d="M10 4a6 6 0 100 12 6 6 0 000-12zM10 14a4 4 0 110-8 4 4 0 010 8z" />
                            </svg>
                        </button>
                    </div>
                    <textarea id="sql-editor" class="w-full h-32 bg-gray-900 border border-gray-600 rounded-md p-2 font-mono text-base focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Schreibe deinen SQL-Befehl hier..."></textarea>
                    <button id="run-query-btn" class="mt-2 w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                        Befehl ausführen
                    </button>
                    <div id="status-message" class="mt-2 text-center h-6"></div>
                </div>
            </section>

            <!-- Rechte Spalte: Ergebnisse -->
            <section id="result-panel" class="lg:w-1/3 flex flex-col bg-gray-800/50 border border-gray-700 rounded-lg p-4 min-h-0">
                <h2 class="text-xl font-bold text-blue-400 mb-2">Abfrage-Ergebnis</h2>
                <div id="result-content" class="flex-grow overflow-auto">
                    <p class="text-gray-500 italic">Das Ergebnis deiner Abfrage erscheint hier.</p>
                </div>
                <button id="next-chapter-btn" class="hidden mt-4 w-full bg-yellow-500 hover:bg-yellow-400 text-gray-900 font-bold py-2 px-4 rounded-lg transition-colors duration-200">
                    Nächstes Kapitel
                </button>
            </section>
        </main>
    </div>

    <!-- NEU: Tutorial Modal -->
    <div id="tutorial-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 border border-yellow-500/50 rounded-lg shadow-xl max-w-2xl w-full p-6 relative">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <h3 class="text-2xl font-bold text-yellow-400 mb-4">Lösung und Erklärung</h3>
            <div id="tutorial-command" class="bg-gray-900 p-3 rounded-md mb-4">
                <code class="font-mono text-cyan-300 text-lg"></code>
            </div>
            <div id="tutorial-explanation" class="text-gray-300 space-y-2">
            </div>
        </div>
    </div>


    <script type="module">
        // --- DATENBANK-SIMULATION ---
        const database = {
            Zeugen: [
                { id: 1, Name: 'Anna Schmidt', Aussage: 'Ich sah eine Person mit Hut weglaufen.' },
                { id: 2, Name: 'Peter Müller', Aussage: 'Ein rotes Auto raste davon.' },
                { id: 3, Name: 'Sabine Klein', Aussage: 'Es war gegen 22:00 Uhr.' }
            ],
            Fahrzeuge: [
                { id: 101, Halter_ID: 201, Typ: 'Limousine', Farbe: 'blau' },
                { id: 102, Halter_ID: 202, Typ: 'Kombi', Farbe: 'rot' },
                { id: 103, Halter_ID: 203, Typ: 'Sportwagen', Farbe: 'schwarz' },
                { id: 104, Halter_ID: 204, Typ: 'Kombi', Farbe: 'rot' },
            ],
            Verdaechtige: [
                { id: 201, Name: 'Max Mustermann', Alibi: 'War zu Hause.' },
                { id: 202, Name: 'Erika Mustermann', Alibi: 'War im Kino.' },
                { id: 203, Name: 'Klaus Kleber', Alibi: 'War bei Freunden.' },
                { id: 204, Name: 'Dieter Dieb', Alibi: 'Unbekannt.' },
            ]
        };
        alasql.options.mysql = true;
        Object.keys(database).forEach(tableName => {
            alasql.tables[tableName] = { data: JSON.parse(JSON.stringify(database[tableName])) };
        });

        // --- KAPITEL-DEFINITIONEN (MIT TUTORIAL) ---
        const chapters = [
            {
                title: "Kapitel 1: Die Grundlagen",
                story: `<p>Willkommen bei der Sondereinheit 'Daten', Anwärter! ... Dein erster Auftrag: Verschaffe dir einen Überblick über alle Zeugen.</p><p class="mt-4 p-2 bg-gray-700/50 rounded-md text-yellow-300"><strong>Aufgabe:</strong> Schreibe einen SQL-Befehl, der <strong>alle</strong> Daten aus der Tabelle <code>Zeugen</code> anzeigt.</p>`,
                solutionCheck: (res) => res && res.length >= 3 && 'Name' in res[0] && 'Aussage' in res[0],
                tutorial: {
                    command: "SELECT * FROM Zeugen;",
                    explanation: `<p><code>SELECT *</code>: Dieser Teil bedeutet "wähle alle Spalten aus". Das Sternchen (*) ist eine Abkürzung für "alle Spalten".</p><p><code>FROM Zeugen</code>: Dieser Teil sagt der Datenbank, aus welcher Tabelle die Daten geholt werden sollen, in diesem Fall aus der Tabelle <strong>Zeugen</strong>.</p><p>Das Semikolon <code>;</code> am Ende ist guter Stil und beendet den Befehl.</p>`
                }
            },
            {
                title: "Kapitel 2: Die Suche eingrenzen",
                story: `<p>Gute Arbeit, Anwärter. Ein Zeuge sprach von einem roten Fluchtauto. ... Mit dem <code>WHERE</code>-Befehl kannst du deine Suche filtern.</p><p class="mt-4 p-2 bg-gray-700/50 rounded-md text-yellow-300"><strong>Aufgabe:</strong> Finde alle Fahrzeuge, deren Farbe <strong>rot</strong> ist.</p>`,
                solutionCheck: (res) => res && res.length === 2 && res.every(car => car.Farbe === 'rot'),
                tutorial: {
                    command: "SELECT * FROM Fahrzeuge WHERE Farbe = 'rot';",
                    explanation: `<p><code>SELECT * FROM Fahrzeuge</code>: Wie im ersten Kapitel wählen wir alle Spalten aus der Tabelle <strong>Fahrzeuge</strong> aus.</p><p><code>WHERE Farbe = 'rot'</code>: Das ist die neue Bedingung. <code>WHERE</code> filtert die Zeilen. Wir wollen nur die, bei denen der Wert in der Spalte <strong>Farbe</strong> exakt <code>'rot'</code> ist. Textwerte müssen immer in einfachen Anführungszeichen stehen.</p>`
                }
            },
            {
                title: "Kapitel 3: Neue Spuren",
                story: `<p>Ausgezeichnet! ... Ein neuer Zeuge hat sich gemeldet: 'Benno Richter' ... Dafür benutzt du <code>INSERT INTO</code>.</p><p class="mt-4 p-2 bg-gray-700/50 rounded-md text-yellow-300"><strong>Aufgabe:</strong> Füge den neuen Zeugen 'Benno Richter' mit seiner Aussage in die <code>Zeugen</code>-Tabelle ein.</p>`,
                solutionCheck: (res, query) => alasql.tables.Zeugen.data.some(z => z.Name === 'Benno Richter'),
                tutorial: {
                    command: "INSERT INTO Zeugen (Name, Aussage) VALUES ('Benno Richter', 'Ich habe den Täter erkannt!');",
                    explanation: `<p><code>INSERT INTO Zeugen (...)</code>: Sagt der Datenbank, dass wir etwas in die Tabelle <strong>Zeugen</strong> einfügen wollen.</p><p><code>(Name, Aussage)</code>: Hier listen wir die Spalten auf, die wir befüllen möchten.</p><p><code>VALUES ('Benno Richter', '...')</code>: Hier geben wir die entsprechenden Werte in der gleichen Reihenfolge an. Wieder in Anführungszeichen, da es Text ist.</p>`
                }
            },
            {
                title: "Kapitel 4: Fehler korrigieren",
                story: `<p>Perfekt, der neue Zeuge ist erfasst. ... Wir müssen bei Anna Schmidt die Aussage korrigieren. ... Um einen bestehenden Eintrag zu ändern, nutzt du <code>UPDATE</code>.</p><p class="mt-4 p-2 bg-gray-700/50 rounded-md text-yellow-300"><strong>Aufgabe:</strong> Korrigiere die Aussage von 'Anna Schmidt' in der <code>Zeugen</code>-Tabelle.</p>`,
                solutionCheck: (res, query) => alasql.tables.Zeugen.data.find(z => z.Name === 'Anna Schmidt')?.Aussage.includes('große'),
                tutorial: {
                    command: "UPDATE Zeugen SET Aussage = 'Ich sah eine große Person mit Hut weglaufen.' WHERE Name = 'Anna Schmidt';",
                    explanation: `<p><code>UPDATE Zeugen</code>: Wir wollen einen Eintrag in der Tabelle <strong>Zeugen</strong> aktualisieren.</p><p><code>SET Aussage = '...'</code>: Wir setzen die Spalte <strong>Aussage</strong> auf einen neuen Wert.</p><p><code>WHERE Name = 'Anna Schmidt'</code>: Dies ist der wichtigste Teil! Er stellt sicher, dass NUR der Eintrag für Anna Schmidt geändert wird. Ohne <code>WHERE</code> würden ALLE Aussagen geändert!</p>`
                }
            },
            {
                title: "Kapitel 5: Der entscheidende Hinweis",
                story: `<p>Fantastisch, Anwärter! Jetzt kommt der entscheidende Schritt. Wir müssen Informationen aus <code>Verdaechtige</code> und <code>Fahrzeuge</code> kombinieren! Dafür gibt es den mächtigen <code>JOIN</code>-Befehl.</p><p class="mt-4 p-2 bg-gray-700/50 rounded-md text-yellow-300"><strong>Aufgabe:</strong> Finde den Namen des Verdächtigen, der ein rotes Auto besitzt.</p>`,
                solutionCheck: (res) => res && res.length === 2 && res.some(r => r.Name === 'Dieter Dieb') && res.some(r => r.Name === 'Erika Mustermann'),
                tutorial: {
                    command: "SELECT Verdaechtige.Name, Fahrzeuge.Typ FROM Verdaechtige JOIN Fahrzeuge ON Verdaechtige.id = Fahrzeuge.Halter_ID WHERE Fahrzeuge.Farbe = 'rot';",
                    explanation: `<p><code>SELECT Verdaechtige.Name, ...</code>: Wir wählen den Namen aus der einen und den Typ aus der anderen Tabelle aus.</p><p><code>FROM Verdaechtige JOIN Fahrzeuge</code>: Wir sagen, dass wir die Tabellen <strong>Verdaechtige</strong> und <strong>Fahrzeuge</strong> verbinden wollen.</p><p><code>ON Verdaechtige.id = Fahrzeuge.Halter_ID</code>: Das ist die "Brücke". Wir verbinden die Zeilen, bei denen die <code>id</code> des Verdächtigen mit der <code>Halter_ID</code> des Fahrzeugs übereinstimmt.</p><p><code>WHERE Fahrzeuge.Farbe = 'rot'</code>: Zum Schluss filtern wir die verbundenen Ergebnisse, um nur die roten Autos anzuzeigen.</p>`
                }
            },
            {
                title: "Fall gelöst!",
                story: `<p class="text-2xl text-yellow-300">HERZLICHEN GLÜCKWUNSCH!</p><p>Du hast das SQL-Lernabenteuer erfolgreich abgeschlossen. Du kannst jetzt weiter mit den Datenbanken experimentieren oder das Spiel neu starten, um deine Fähigkeiten zu festigen.</p>`,
                isEnd: true
            }
        ];

        // --- ANWENDUNGS-LOGIK ---
        let currentChapterIndex = 0;
        let activeTable = Object.keys(database)[0];

        const chapterTitleEl = document.getElementById('chapter-title');
        const storyContentEl = document.getElementById('story-content');
        const sqlEditorEl = document.getElementById('sql-editor');
        const runQueryBtn = document.getElementById('run-query-btn');
        const statusMessageEl = document.getElementById('status-message');
        const resultContentEl = document.getElementById('result-content');
        const nextChapterBtn = document.getElementById('next-chapter-btn');
        const dbTabsEl = document.getElementById('db-tabs');
        const dbContentEl = document.getElementById('db-content');

        // NEU: Modal-Elemente
        const tutorialModal = document.getElementById('tutorial-modal');
        const hintBtn = document.getElementById('hint-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const tutorialCommandEl = document.getElementById('tutorial-command').querySelector('code');
        const tutorialExplanationEl = document.getElementById('tutorial-explanation');
        
        function typeWriter(element, text, speed = 15) {
            element.innerHTML = "";
            let i = 0;
            const parser = new DOMParser();
            const doc = parser.parseFromString(`<!doctype html><body>${text}`, 'text/html');
            const allNodes = Array.from(doc.body.childNodes);
            
            function typeNode(nodeIndex) {
                if (nodeIndex >= allNodes.length) return;
                
                const node = allNodes[nodeIndex];
                element.appendChild(node.cloneNode(true));
                setTimeout(() => typeNode(nodeIndex + 1), 200);
            }
            
            // For simplicity, we'll just set the HTML directly. A real typewriter effect on HTML is more complex.
            element.innerHTML = text;
        }

        function renderChapter(index) {
            // Reset database for chapters that modify data
            if (index >= 2) {
                 Object.keys(database).forEach(tableName => {
                    alasql.tables[tableName] = { data: JSON.parse(JSON.stringify(database[tableName])) };
                });
            }

            const chapter = chapters[index];
            chapterTitleEl.textContent = chapter.title;
            typeWriter(storyContentEl, chapter.story);
            
            sqlEditorEl.value = "";
            statusMessageEl.innerHTML = "";
            resultContentEl.innerHTML = `<p class="text-gray-500 italic">Das Ergebnis deiner Abfrage erscheint hier.</p>`;
            nextChapterBtn.classList.add('hidden');
            
            const isEnd = !!chapter.isEnd;
            runQueryBtn.disabled = isEnd;
            sqlEditorEl.disabled = isEnd;
            hintBtn.style.display = isEnd ? 'none' : 'block';

            if (isEnd) {
                 sqlEditorEl.placeholder = "Fall gelöst!";
            } else {
                 sqlEditorEl.placeholder = "Schreibe deinen SQL-Befehl hier...";
            }
            
            renderDbTabs();
            renderDbContent();
        }
        
        function renderDbTabs() {
            dbTabsEl.innerHTML = '';
            Object.keys(database).forEach(tableName => {
                const isActive = tableName === activeTable;
                const tab = document.createElement('button');
                tab.textContent = tableName;
                tab.className = `px-4 py-1 text-sm font-semibold rounded-t-md transition-colors ${isActive ? 'bg-gray-700 text-green-400' : 'text-gray-400 hover:bg-gray-700/50'}`;
                tab.onclick = () => {
                    activeTable = tableName;
                    renderDbTabs();
                    renderDbContent();
                };
                dbTabsEl.appendChild(tab);
            });
        }

        function renderDbContent() {
            const data = alasql.tables[activeTable].data;
            renderTable(data, dbContentEl);
        }

        function renderTable(data, element) {
            if (!data || data.length === 0) {
                element.innerHTML = `<p class="text-gray-500 italic">Keine Daten zum Anzeigen.</p>`;
                return;
            }

            const headers = Object.keys(data[0]);
            const table = document.createElement('table');
            table.className = 'w-full text-left border-collapse';

            const thead = table.createTHead();
            thead.className = "bg-gray-700/50";
            const headerRow = thead.insertRow();
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.className = 'p-2 border-b border-gray-600 font-bold';
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            const tbody = table.createTBody();
            data.forEach(rowData => {
                const row = tbody.insertRow();
                row.className = "hover:bg-gray-700/30";
                headers.forEach(header => {
                    const cell = row.insertCell();
                    cell.className = 'p-2 border-b border-gray-600 font-mono';
                    cell.textContent = rowData[header];
                });
            });

            element.innerHTML = '';
            element.appendChild(table);
        }

        function handleRunQuery() {
            const query = sqlEditorEl.value.trim();
            if (!query) return;

            statusMessageEl.innerHTML = "";
            const chapter = chapters[currentChapterIndex];

            try {
                const res = alasql(query);
                
                if (query.toUpperCase().startsWith('SELECT')) {
                    renderTable(res, resultContentEl);
                } else {
                    resultContentEl.innerHTML = `<p class="text-green-400">Befehl erfolgreich ausgeführt.</p>`;
                    renderDbContent();
                }

                if (chapter.solutionCheck(res, query)) {
                    statusMessageEl.innerHTML = `<span class="text-green-400 font-bold">Erfolg! Das war der richtige Hinweis.</span>`;
                    nextChapterBtn.classList.remove('hidden');
                } else {
                    statusMessageEl.innerHTML = `<span class="text-yellow-400">Das Ergebnis ist nicht ganz richtig. Versuche es erneut.</span>`;
                }

            } catch (e) {
                statusMessageEl.innerHTML = `<span class="text-red-400 font-bold">Fehler!</span>`;
                resultContentEl.innerHTML = `<p class="text-red-400 font-mono">${e.message}</p>`;
            }
        }
        
        // NEU: Modal-Logik
        function showTutorial() {
            const chapter = chapters[currentChapterIndex];
            if (chapter && chapter.tutorial) {
                tutorialCommandEl.textContent = chapter.tutorial.command;
                tutorialExplanationEl.innerHTML = chapter.tutorial.explanation;
                tutorialModal.classList.remove('hidden');
            }
        }
        
        function hideTutorial() {
            tutorialModal.classList.add('hidden');
        }

        hintBtn.addEventListener('click', showTutorial);
        closeModalBtn.addEventListener('click', hideTutorial);
        tutorialModal.addEventListener('click', (e) => {
            if (e.target === tutorialModal) {
                hideTutorial();
            }
        });

        runQueryBtn.addEventListener('click', handleRunQuery);
        sqlEditorEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                handleRunQuery();
            }
        });

        nextChapterBtn.addEventListener('click', () => {
            if (currentChapterIndex < chapters.length - 1) {
                currentChapterIndex++;
                renderChapter(currentChapterIndex);
            }
        });

        // Initialisierung
        renderChapter(currentChapterIndex);

    </script>
</body>
</html>
